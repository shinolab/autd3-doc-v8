# Pulse Witdth Encoder

| Name                         | In/Out | Width | Description                                        | 
| ---------------------------- | ------ | ----- | -------------------------------------------------- | 
| CLK                          | In     | 1     | 20.48MHzクロック                                   | 
| PULSE_WIDTH_ENCODER_SETTINGS | In     | -     |                                                    | 
| └─ FULL_WIDTH_START          | In     | 16    | 最大出力とする強度の始まり                         | 
| DUTY_TABLE_BUS               | In     | -     | メモリバス                                         | 
| DIN_VALID                    | In     | 1     | 強度/位相データ有効フラグ                          | 
| INTENSITY_IN                 | In     | 16    | 強度                                               | 
| PHASE_IN                     | In     | 8     | 位相                                               | 
| PULSE_WIDTH_OUT              | Out    | 9     | パルス幅                                           | 
| PHASE_OUT                    | Out    | 8     | 位相                                               | 
| DOUT_VALID                   | Out    | 1     | パルス幅/位相データ有効フラグ                      | 


このモジュールは, 強度をパルス幅に変換する.
強度$A$とパルス幅$D$の関係は, 理想的には
$$\begin{aligned}
  A    & \propto \sin\left(\pi \frac{D}{T}\right)
\end{aligned}$$
となる. ここで, $T$は周期である.
このモジュールはこれの逆変換を行うためのモジュールである.

> NOTE: 端からパルス幅を使用しないのは, 強度にAM変調をかけるためである.

ただし, 上記は理想的な変換であり, 現実とは異なる可能性がある.
そのため, このモジュールでは, 強度をインデックス, パルス幅を値とするテーブルを利用している. 
このテーブルは, 書き込み可能になっているため, 任意の変換を実現する事ができる.
(デフォルトでは, 上記の理想的な変換を行うテーブルが用意されている.)

なお, 周期が$T=512$なので, 超音波出力が最大になるのはパルス幅が$T/2=256$のときであり, データ幅は$\SI{9}{bit}$必要になる.
したがって, 本来であれば, テーブルサイズは$\SI{16}{bit}\times2^{16}$必要になる (BRAMのデータ幅は$\SI{8}{bit}$単位のため) が, これは無駄が多い.
そのため, テーブルサイズは$\SI{8}{bit}\times2^{16}$とし, 以下の処理によって, パルス幅$D$を$\SI{9}{bit}$にしている.
$$\begin{aligned}
    D = \begin{cases}
            PWE[A] & (A < \text{FULL\_WIDTH\_START}) \\
            256 + PWE[A] & (\text{Otherwise})   \\
        \end{cases}
\end{aligned}$$
ここで, $A$は強度, $PWE[A]$は強度をインデックスとするテーブルの出力である.

このモジュールの処理もパイプライン的に行われる.
入力として, `DIN_VALID`は249クロックの間1であり, その間`INTENSITY_IN`, `PHASE_IN`から強度/位相データが順番に流れてくることを想定している.
処理が終わったら, `DOUT_VALID`を1とし, 順次`PULSE_WIDTH_OUT`, `PHASE_OUT`からパルス幅/位相データを流す.

> NOTE: 位相に関しては何も処理しないが, ディレイを入れてパルス幅データと歩調を揃えている.
