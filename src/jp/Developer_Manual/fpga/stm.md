# STM

<figure>
  <a href="../../fig/Developers_Manual/FPGA/stm.svg" data-lightbox="image"><img src="../../fig/Developers_Manual/FPGA/stm.svg"/></a>
  <figcaption>STMモジュール</figcaption>
</figure>

| Name                          | In/Out | Width | Description                                        | 
| ----------------------------- | ------ | ----- | -------------------------------------------------- | 
| CLK                           | In     | 1     | メインクロック                                     | 
| SETTINGS                      | In     | -     |                                                    | 
| ├─ REQ_RD_SEGMENT             | In     | 1     | 要求読み込みセグメント                             | 
| ├─ CYCLE[$n$]                 | In     | 13    | 第$n$セグメントの周期$-1$                          | 
| ├─ FREQ_DIV[$n$]              | In     | 32    | 第$n$セグメントの周波数分周比                      | 
| ├─ REP[$n$]                   | In     | 32    | 第$n$セグメントの繰り返し回数$-1$                  | 
| ├─ SOUND_SPEED[$n$]           | In     | 16    | 第$n$セグメントの音速                              | 
| ├─ TRANSITION_MODE            | In     | 8     | 遷移モード                                         | 
| └─ TRANSITION_VALUE           | In     | 64    | 遷移値                                             | 
| SYS_TIME                      | In     | 64    | システム時刻                                       | 
| INTENSITY                     | Out    | 8     | 強度                                               | 
| PHASE                         | Out    | 8     | 位相                                               | 
| DOUT_VALID                    | Out    | 1     | 強度/位相データ有効フラグ                          | 
| STM_BUS                       | In     | -     | 位相フィルタ用メモリバス                           | 

本モジュールは, 強度/位相データを出力する.

## Timer

このサブモジュールは, システム時刻, 周期$T$, 周波数分周比$N$から, 現在読み込むべきデータのインデックスを計算する.
変調データのインデックス$i$は
$$\begin{align}
    i = \left\lfloor \frac{\text{SYS\_TIME}}{N} \right\rfloor \,\%\, T
\end{align}$$
として計算される.
`SYS_TIME`はメインクロックでカウントアップされため, データのサンプリング周波数$f$は
$$\begin{align}
    f = \frac{\text{メインクロック周波数}}{N}
\end{align}$$
となり, $i$はこの周波数で$0$から$T−1$まで周期的にカウントアップされる.

`SYS_TIME`がすべてのデバイスで同期しているため, このインデックスも必然的にすべてのデバイスで同期する.

> NOTE: `SETTINGS`で指定する`CYCLE`は$T−1$であることに注意する.

## Swapchain

このサブモジュールはセグメントの切り替えを制御する.

セグメント切替時の挙動は以下の通りである.

1. 現在のセグメントが0, 要求されたセグメントが0の場合, 何もしない.
1. 現在のセグメントが0, 要求されたセグメントが1の場合
    1. 第1セグメントの繰り返し回数が0xFFFFFFFFの場合, 直ちにセグメントを1に切り替え, 無限ループする.
        - 遷移モードが`EXT`の場合, セグメントないのデータを一周するたび, セグメントを自動的に切り替える.
    1. 第1セグメントの繰り返し回数が0xFFFFFFFF以外の場合, 遷移モードに従って, セグメントの切り替えを待機する. セグメント切り替え後, 指定回数の繰り返しが終わった後, `STOP`をアサートする.
        - 遷移モードが`SYNC_IDX`の場合, 第1セグメントのインデックスが0になったら, セグメントを1に切り替える.
        - 遷移モードが`SYS_TIME`の場合, システム時間が遷移値で指定された値になったらセグメントを1に切り替え, インデックスを0に初期化.
        - 遷移モードが`GPIO`の場合, 遷移値で指定されたGPIO Inピンがアサートされたらセグメントを1に切り替え, インデックスを0に初期化
1. 現在のセグメントが1の場合も同様

> NOTE: `SETTINGS`で指定する`REP`は繰り返し回数$−1$であることに注意する.

## Gain

このモジュールは, 指定されたインデックスのデータを順次出力するだけである.

## Focus

このモジュールはBRAMに書き込まれた焦点の位置データ列から適切な位相を計算して出力する.

焦点の位置データはデバイスにローカルな座標系で表現される.
また, 位置データは$\SI{18}{bit}$符号あり固定小数点数で表現される.
この単位は$\SI{0.025}{mm}$である.

このモジュールでは, 焦点位置データ$\br_\text{f}$と, 振動子の位置データ$\br_\text{tr}$, 及び, 音速 (`SOUND_SPEED`, $c$) から, 振動子の位相を計算する.
ここで, 音速の単位は超音波周波数$f$に対して, $\displaystyle \frac{f}{64\times \SI{40}{kHz}} \SI{}{m/s}$である.
また, 振動子のローカル座標における位置データはあらかじめ計算しておくことができるため, これを専用のBRAMに格納しておく.

> NOTE: 振動子の位置データは`tr.coe`に格納されている.

まず, $\br_\text{f}$と$\br_\text{tr}$の間の距離を計算する.
$$\begin{align}
    d = \sqrt{\|\br_\text{f} - \br_\text{tr}\|^2} \times \SI{0.025}{mm}
\end{align}$$
また,
音速$c$から波長$\lambda$を計算すると,
$$\begin{align}
    \lambda = \frac{c}{f} = \frac{c \times \frac{f}{64\times \SI{40}{kHz}}\SI{}{m/s}}{f} = \frac{c}{2^{6}}  \times \SI{0.025}{mm}
\end{align}$$
となる.
よって, 位相$p$は
$$\begin{align}
    p & = \left(256\times\frac{d}{\lambda}\right) \,\%\,256                                \\
      & = \frac{\sqrt{\|\br_\text{f} - \br_\text{tr}\|^2} \times 2^{14}}{c} \,\%\,256
\end{align}$$
と計算できる.

> NOTE: $256$が$2\pi$に対応することに注意.

> NOTE: 音速の単位が複雑なのは以下の理由による. まず, 振動子-焦点間距離の計算において, 各座標の入力値が$\SI{18}{bit}$符号あり固定小数点数なので, その値の二乗値のビット幅は$\lceil\log_2 (3\times (2^{17})^2)\rceil=\SI{36}{bit}$となる. したがって, 距離の値のビット幅$\SI{18}{bit}$になる. 音速の単位を上記のようにしておくと, 位相の計算の際, 分母の計算が楽になり, その値を$\SI{32}{bit}$の範囲に収められる.

### 多焦点

`Focus`モジュールは上記の計算を同時8焦点分行い, 各焦点の位相$p_i$から, 以下の計算により, 最終的な位相データ$P$を求める.

$$\begin{align}
 P = \tan^{-1} \frac{\sum_0^N \sin(p_i)}{\sum_0^N \cos(p_i)}
\end{align}$$
ここで, $N$は焦点の数である.

$\sin, \cos$の計算に関しては$p_i$が$\SI{8}{bit}$の有限値であるため, あらかじめ計算済みの$\sin$テーブルを用いる.
また, $\tan^{-1}$の計算も, 計算済みのテーブルを用いる.
$\tan^{-1}$のテーブルはデータ量を削減するため, $\SI{8}{bit}$の$\sin(p_i)$の平均値$\displaystyle S = \frac{\sum_0^N \sin(p_i)}{N}$, $\cos(p_i)$の平均値$\displaystyle C = \frac{\sum_0^N \cos(p_i)}{N}$に対して, $\lbrace S[7:1], C[7:1]\rbrace$をキーとしている.
